<%#
LuCI - Lua Configuration Interface
Copyright 2008 Steven Barth <steven@midlink.org>
Copyright 2008-2011 Jo-Philipp Wich <xm@subsignal.org>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

	http://www.apache.org/licenses/LICENSE-2.0

$Id: lan.htm 7022 2011-05-04 21:04:31Z jow $

-%>

<%-
	local ntm = require "luci.model.network".init()

	local net
	local netlist = { }
	for _, net in ipairs(ntm:get_networks()) do
		if net:name() == "lan" then
			netlist[#netlist+1] = net:name()
		end
	end
-%>

<%+header%>

<script type="text/javascript">//<![CDATA[
	function iface_shutdown(id, reconnect) {
		if (!reconnect && !confirm(String.format('<%_Really shutdown interface "%s" ?\nYou might loose access to this router if you are connected via this interface.%>', id)))
			return;

		var a = document.getElementById(id + '-ifc-addrs');
		if (a)
			a.innerHTML = reconnect
				? '<em><%:Interface is reconnecting...%></em>'
				: '<em><%:Interface is shutting down...%></em>';

		var s = document.getElementById('ifc-rc-status');
		if (s)
		{
			s.parentNode.style.display = 'block';
			s.innerHTML = '<%:Waiting for router...%>';
		}

		var rcxhr = new XHR();
		rcxhr.get('<%=luci.dispatcher.build_url("admin", "status")%>/iface_' + (reconnect ? 'reconnect' : 'shutdown') + '/' + id, null,
			function(x)
			{
				if (s)
				{
					s.innerHTML = reconnect
						? '<%:Interface reconnected%>'
						: '<%:Interface shut down%>';

					window.setTimeout(function() {
						s.parentNode.style.display = 'none';
					}, 1000);
				}
			}
		);
	}

	var iwxhr = new XHR();
	var wifidevs = <%=luci.http.write_json(netdevs)%>;
	var arptable = <%=luci.http.write_json(arpcache)%>;

	var update_status = function() {
		iwxhr.get('<%=luci.dispatcher.build_url("admin", "status", "iface_status", table.concat(netlist, ","))%>', null,
			function(x, ifcs)
			{
			        
				if (ifcs)
				{
					for (var i = 0; i < ifcs.length; i++)
					{
						var ifc = ifcs[i];
						var is_up = (ifc.flags && ifc.flags.up);
						var rxb = ifc.stats ? ifc.stats["rx_bytes"] : 0;
						var txb = ifc.stats ? ifc.stats["tx_bytes"] : 0;
						var rxp = ifc.stats ? ifc.stats["rx_packets"] : 0;
						var txp = ifc.stats ? ifc.stats["tx_packets"] : 0;
						var mac = ifc.macaddr ? ifc.macaddr : '00:00:00:00:00:00';
						var upt = '-';
                                               
						var m = document.getElementById(ifc.id + '-ifc-mac');
						if (m)
						{
							m.innerHTML = mac.toUpperCase();
						}

						var a = document.getElementById(ifc.id + '-ifc-addrs');
						if (a)
						{
							if (ifc.ifname)
							{
								a.innerHTML = '';

								if (ifc.ipaddrs && ifc.ipaddrs.length)
								{									
									for (var j = 0; j < ifc.ipaddrs.length; j++)
										a.innerHTML += String.format(
											'%s%s',
											j ? ', ' : '',
											ifc.ipaddrs[j].addr											
										);
								}								

								if (!a.innerHTML)
									a.innerHTML = '<em><%:No address configured on this interface.%></em>'
							}
							else
							{
								a.innerHTML = '<em><%:Interface not present or not connected yet.%></em>';
							}
						}

                        var nm = document.getElementById(ifc.id + '-ifc-netmask');
						if (nm)
						{
							if (ifc.ifname)
							{
								nm.innerHTML = '';

								if (ifc.ipaddrs && ifc.ipaddrs.length)
								{									
									for (var j = 0; j < ifc.ipaddrs.length; j++)
										nm.innerHTML += String.format(
											'%s%s',
											j ? ', ' : '',
											ifc.ipaddrs[j].netmask											
										);
								}								

								if (!nm.innerHTML)
									nm.innerHTML = '<em><%:No address configured on this interface.%></em>'
							}
							else
							{
								nm.innerHTML = '<em><%:Interface not present or not connected yet.%></em>';
							}
						}
						var t = document.getElementById(ifc.id + '-ifc-transfer');
						if (t)
						{
							t.innerHTML = String.format(
								'<strong><%:RX%></strong>: %1024.2mB (%d <%:Pkts.%>)<br />' +
								'<strong><%:TX%></strong>: %1024.2mB (%d <%:Pkts.%>)<br />',
									rxb, rxp, txb, txp
							);
						}
					}
				}

		//		window.setTimeout(update_status, 5000);
			}
		)
	};

	update_status();
//]]></script>
	
    <div class="cbi-content">
    	<div class="cbi-section">
        	<div class="cbi-section-bg">
        		<div class="cbi-section-title"><%:WLAN Status%>&nbsp;&nbsp;</div>
            </div>
    	</div>
    	<div class="cbi-section">
            <div class="cbi-section-bg">
                <div class="cbi-table">
                	<table width="630" border="1" class="cbi-table-list" cellpadding="1" cellspacing="0" align="center">
                    <tr>
                        <td class="cbi-table-title"><%:Wireless Status%></td>
                        <td class="cbi-table-field" id="wlan-ifc-status">Enable</td>
                    </tr>
                    <tr>
                        <td class="cbi-table-title"><%:Channel%></td>
                        <td class="cbi-table-field" id="wlan-ifc-channel">9</td>
                    </tr>
                    <tr>
                        <td class="cbi-table-title"><%:Statics%></td>
                        <td class="cbi-table-field" id="wlan-ifc-statics">8585kps</td>
                    </tr>
                    <tr>
                        <td class="cbi-table-title"><%:SSID%></td>
                        <td class="cbi-table-field" id="wlan-ifc-ssid">ChinaNet-RL1</td>
                    </tr>
                    <tr>
                        <td class="cbi-table-title"><%:Encryption Mode%></td>
                        <td class="cbi-table-field" id="wlan-ifc-encryption">WPA-PSK(AES)</td>
                    </tr>
                    </table>
                </div>
            </div>
		</div>
        <div class="cbi-section">
            <div class="cbi-section-bg">
                <div class="cbi-section-title"><%:USB Status%>&nbsp;&nbsp;</div>
            </div>
        </div>
            
        <div class="cbi-section">
            <div class="cbi-section-bg">
            	<div class="cbi-table">
                	<table width="630" border="1" class="cbi-table-list" cellpadding="1" cellspacing="0" align="center">
                    <tr>
                        <td class="cbi-table-title"><%:USB-0%></td>
                        <td class="cbi-table-field" id="usb0-ifc-status">-</td>
                    </tr>
                    <tr>
                        <td class="cbi-table-title"><%:IP Address%></td>
                        <td class="cbi-table-field" id="lan-ifc-addrs">-</td>
                    </tr>
                    <tr>
                        <td class="cbi-table-title"><%:Subnet Mask%></td>
                        <td class="cbi-table-field" id="lan-ifc-netmask">-</td>
                    </tr>
                    <tr>
                        <td class="cbi-table-title"><%:Transfer%></td>
                        <td class="cbi-table-field" id="lan-ifc-transfer">-</td>
                    </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

<%+footer%>
