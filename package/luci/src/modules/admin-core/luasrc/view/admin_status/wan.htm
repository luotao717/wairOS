<%#
LuCI - Lua Configuration Interface
Copyright 2010 Jo-Philipp Wich <xm@subsignal.org>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

	http://www.apache.org/licenses/LICENSE-2.0

$Id: iface_overview.htm 7011 2011-05-03 03:20:15Z jow $

-%>
 
<%-
	local ntm = require "luci.model.wanlink".init()

	local net
	local netlist = { }
	for _, net in pairs(ntm.waninfo_get()) do
		if net.ConnName  then
			netlist[#netlist+1] = net.ConnName
		end
	end
	
-%>

<%+header%>

<script type="text/javascript">//<![CDATA[
	function iface_shutdown(id, reconnect) {
		if (!reconnect && !confirm(String.format('<%_Really shutdown interface "%s" ?\nYou might loose access to this router if you are connected via this interface.%>', id)))
			return;

		var a = document.getElementById(id + '-ifc-addrs');
		if (a)
			a.innerHTML = reconnect
				? '<em><%:Interface is reconnecting...%></em>'
				: '<em><%:Interface is shutting down...%></em>';

		var s = document.getElementById('ifc-rc-status');
		if (s)
		{
			s.parentNode.style.display = 'block';
			s.innerHTML = '<%:Waiting for router...%>';
		}

		var rcxhr = new XHR();
		rcxhr.get('<%=luci.dispatcher.build_url("admin", "status")%>/iface_' + (reconnect ? 'reconnect' : 'shutdown') + '/' + id, null,
			function(x)
			{
				if (s)
				{
					s.innerHTML = reconnect
						? '<%:Interface reconnected%>'
						: '<%:Interface shut down%>';

					window.setTimeout(function() {
						s.parentNode.style.display = 'none';
					}, 1000);
				}
			}
		);
	}


	var iwxhr = new XHR();
	var wifidevs = <%=luci.http.write_json(netdevs)%>;
	var arptable = <%=luci.http.write_json(arpcache)%>;

	var update_status = function() {
		iwxhr.get('<%=luci.dispatcher.build_url("admin", "status", "iface_wanlink_status", table.concat(netlist, ","))%>', null,
			function(x, ifcs)
			{
				if (ifcs)
				{
					for (var i = 0; i < ifcs.length; i++)
					{
						var ifc = ifcs[i];
						var is_up = (ifc.flags && ifc.flags.up);
						var rxb = ifc.stats ? ifc.stats["rx_bytes"] : 0;
						var txb = ifc.stats ? ifc.stats["tx_bytes"] : 0;
						var rxp = ifc.stats ? ifc.stats["rx_packets"] : 0;
						var txp = ifc.stats ? ifc.stats["tx_packets"] : 0;
						var mac = ifc.macaddr ? ifc.macaddr : '00:00:00:00:00:00';
						var upt = '-';

						var icon;
						if (is_up)
						{
							if (ifc.status)
								upt = String.format('%s', ifc.status);

							icon = "<%=resource%>/icons/ethernet.png";
						}
						else
						{
							icon = "<%=resource%>/icons/ethernet_disabled.png";
						}

						var s = document.getElementById(ifc.id + '-ifc-signal');
						if (s)
						{
							s.innerHTML = String.format(
								'<img src="%s" style="width:16px; height:16px" /><br />' +
								'<small>%s</small>',
									icon, ifc.ifname ? ifc.ifname : '?'
							);
						}

						var u = document.getElementById(ifc.id + '-ifc-name');
						if (u)
						{
							u.innerHTML = ifc.connname ? ifc.connname : '-';
						}

						var u = document.getElementById(ifc.id + '-ifc-status');
						if (u)
						{
							u.innerHTML = upt;
						}

						var m = document.getElementById(ifc.id + '-ifc-mac');
						if (m)
						{
							m.innerHTML = mac.toUpperCase();
						}

						var a = document.getElementById(ifc.id + '-ifc-addrs');
						if (a)
						{
							if (ifc.ifname)
							{
								a.innerHTML = '';

								if (ifc.ipaddrs && ifc.ipaddrs.length)
								{
									a.innerHTML += '<strong><%:IPv4%>: </strong>';

									for (var j = 0; j < ifc.ipaddrs.length; j++)
										a.innerHTML += String.format(
											'%s%s/%d',
											j ? ', ' : '',
											ifc.ipaddrs[j].addr,
											ifc.ipaddrs[j].prefix
										);

									a.innerHTML += '<br />';
								}
								/*
								if (ifc.ip6addrs && ifc.ip6addrs.length)
								{
									a.innerHTML += '<strong><%:IPv6%>: </strong>';

									for (var j = 0; j < ifc.ip6addrs.length; j++)
										a.innerHTML += String.format(
											'%s%s/%d',
											j ? ', ' : '',
											ifc.ip6addrs[j].addr.toUpperCase(),
											ifc.ip6addrs[j].prefix
										);

									a.innerHTML += '<br />';
								}
								*/
								if (!a.innerHTML)
									a.innerHTML = '<em><%:No address configured on this interface.%></em>'
							}
							else
							{
								a.innerHTML = '<em><%:Interface not present or not connected yet.%></em>';
							}
						}

						var t = document.getElementById(ifc.id + '-ifc-transfer');
						if (t)
						{
							t.innerHTML = String.format(
								'<strong><%:RX%></strong>: %1024.2mB (%d <%:Pkts.%>)<br />' +
								'<strong><%:TX%></strong>: %1024.2mB (%d <%:Pkts.%>)<br />',
									rxb, rxp, txb, txp
							);
						}
					}
				}

			//	window.setTimeout(update_status, 5000);
			}
		)
	};

	update_status();
//]]></script>
	<div class="cbi-content">
    	<div class="cbi-section">
        	<div class="cbi-section-bg">
        	  	<div class="cbi-section-title"><%:WAN Status%>&nbsp;&nbsp;</div>
            </div>
    	</div>
   		<div class="cbi-section">
    	<% for i, net in ipairs(netlist) do %>
   			<div class="cbi-section-bg"> 	 
              	<div class="cbi-section-title"><span  id="<%=net%>-ifc-name">-</span>&nbsp;&nbsp;</div>      
            </div>
            <div class="cbi-section">
                <div class="cbi-section-bg">       
                    <div class="cbi-table">
                        <table width="630" border="1" class="cbi-table-list" cellpadding="1" cellspacing="0" align="center">
                        <tr>
                            <td class="cbi-table-title"><%:Interface%></td>
                            <td class="cbi-table-field" id="<%=net%>-ifc-signal">-</td>
                        </tr>
                        <tr>
                            <td class="cbi-table-title"><%:Status%></td>
                            <td class="cbi-table-field" id="<%=net%>-ifc-status">-</td>
                        </tr>
                        <tr>
                            <td class="cbi-table-title"><%:MAC Address%></td>
                            <td class="cbi-table-field" id="<%=net%>-ifc-mac">-</td>
                        </tr>
                        <tr>
                            <td class="cbi-table-title"><%:IP Address%></td>
                            <td class="cbi-table-field" id="<%=net%>-ifc-addrs">-</td>
                        </tr>                 
                        <tr>
                           <td class="cbi-table-title"><%:Transfer%></td>
                           <td class="cbi-table-field" id="<%=net%>-ifc-transfer">
                                <strong><%:RX%></strong>: 0 <%:KB%> (0 <%:Pkts.%>)<br />
                                <strong><%:TX%></strong>: 0 <%:KB%> (0 <%:Pkts.%>)
                           </td>
                        </tr>
                        </table>
                    </div>	     
                </div>     	
             </div>
        <%end%>
  		</div>
	</div>
<%+footer%>